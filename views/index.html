<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/bootstrap/css/bootstrap.min.css">
  <title>IA</title>

  <style>
    body {
      margin: 0;
      padding: 0;
      height: 100vh;
      overflow: hidden;
    }

    .videoMsg {
      position: absolute;
      z-index: 10;
      top: 72%;
    }

    .spanVideoMsg {
      color: white;
      font-size: 20px;
    }
  </style>
</head>

<body id="cuerpo">

  <video muted autoplay loop preload="auto" width="100%" height="100%" style="position: fixed; overflow: hidden;  padding: 0; margin: 0; " id="reposoTrack">
    <source src="/media/video/reposo/reposo.mp4" type="video/mp4">
    <source src="/media/video/reposo/reposo.wav" type="video/wav">
    <source src="/media/video/reposo/reposo.webm" type="video/webm">
    <source src="/media/video/reposo/reposo.ogg" type="video/ogg">
    Tu navegador no soporta HTML5 video.
  </video>

  <video style="display:none;" src="/media/video/saludo/saludo.mp4" preload="auto" width="100%" height="100%" style="position: fixed; overflow: hidden;  padding: 0; margin: 0; " id="saludoTrack">
    Tu navegador no soporta HTML5 video.
  </video>

  <video style="display:none;" src="/media/video/pregunta/pregunta.mp4" preload="auto" width="100%" height="100%" style="position: fixed; overflow: hidden;  padding: 0; margin: 0; " id="preguntaTrack">
    Tu navegador no soporta HTML5 video.
  </video>

  <div class="container-fluid videoMsg d-none" id="videoMsgRespuesta">
    <div class="row justify-content-center d-flex align-items-center text-center">
      <div class="col-md-4 p-3 justify-content-center d-flex align-items-center text-center" style="background-color: black;">
        <span class="spanVideoMsg text-center">Contesta y al final menciona la palabra 'ahora'</span>
      </div>
    </div>
  </div>

  <video style="display:none;" src="/media/video/respuesta/respuesta.mp4" preload="auto" width="100%" height="100%" style="position: fixed; overflow: hidden;  padding: 0; margin: 0; " id="respuestaTrack">
    Tu navegador no soporta HTML5 video.
  </video>

  <video style="display:none;" src="/media/video/cierre/cierre.mp4" preload="auto" width="100%" height="100%" style="position: fixed; overflow: hidden;  padding: 0; margin: 0; " id="cierreTrack">
    Tu navegador no soporta HTML5 video.
  </video>

  <script src="/artyom.window.min.js"></script>
  <script src="/bootstrap/js/bootstrap.min.js"></script>
  <script src="/functions.js"></script>

  <script>
    // SWITCH LENGUAGE
    function start(language, mode) {
      if (!language)
        language = Jarvis.getLanguage();


      let _startArtyom = function() {
        Jarvis.initialize({
          lang: language, // Start artyom with provided language
          continuous: true, // Continuous mode enabled
          listen: true, // Start recognizing
          debug: true, // Show everything in the console
          speed: 1, // talk normally
          volume: 5,
          soundex: true,
          mode: mode, // Opciones: quick, normal, slow
          // name: "jarvis"
          executionKeyword: "now" // say "now" at the end of a command to execute it immediately
        });

        console.log("Artyom is listening to your commands");
      };

      // stop artyom if stills active
      Jarvis.fatality();
      setTimeout(_startArtyom, 250);
    }
  </script>

  <script>
    // let respuestaMode = 'normal';
    let respuestaMode = 'quick';

    document.getElementById('saludoTrack').addEventListener('play', function() {
      Jarvis.dontObey();
    });

    document.getElementById('saludoTrack').addEventListener('ended', function() {
      Jarvis.obey();
      this.removeAttribute('muted')
      this.defaultMuted = false;

      setTimeout(() => {
        playVideo('preguntaTrack');
      }, 1200);
    });

    // document.getElementById('respuestaTrack').addEventListener('play', () => {
    //   setTimeout(() => {
    //     document.getElementById("videoMsgRespuesta").classList.remove("d-none");
    //   }, 140);
    // });

    document.getElementById('respuestaTrack').addEventListener('ended', () => {

      document.getElementById("videoMsgRespuesta").classList.add("d-none");
      // stop artyom if stills active
      Jarvis.fatality();
      setTimeout(() => {
        start('es-ES', respuestaMode);
      }, 250)
    });

    function configVideos(arrVideoElementsIds = ["reposoTrack", "saludoTrack", "preguntaTrack", "respuestaTrack", "cierreTrack"]) {
      arrVideoElementsIds.forEach(video => {
        let videoElement = document.getElementById(video);
        videoElement.style.width = screen.width;
        videoElement.style.height = screen.height;

        if (video != 'reposoTrack') {
          document.getElementById(video).addEventListener('ended', () => {
            document.getElementById(video).style.display = 'none';
            document.getElementById('reposoTrack').style.display = 'inherit';
            document.getElementById('reposoTrack').play();
          });

          document.getElementById(video).addEventListener('play', () => {
            document.getElementById('reposoTrack').style.display = 'none';
          });
        }
      });
    }

    async function playVideo(videoId) {
      document.getElementById(videoId).style.display = 'inherit';
      await document.getElementById(videoId).play();
    }

    configVideos();
  </script>

  <script>
    let Jarvis = new Artyom();

    //   /**
    //    * Note that this commands will work only in english mode .. in other language they will be not so good 
    //    * recognized.
    //    */
    Jarvis.addCommands({
      // note that if you're in spanish for example
      // the command should be instead : "Iniciar en ingles, Iniciar en alemán" etc...
      indexes: ["pasar a italiano", "pasar a alemán",
        "pasar a francés", "pasar a español",
        "pasar a portuges", "pasar a holandés",
        "pasar a polaco", "pasar a indonesio",
        "pasar a inglés"
      ],
      action: function(i) {
        switch (i) {
          case 0:
            stop();
            start("it-IT");
            break;
          case 1:
            start("de-IT");
            break;
          case 2:
            start("fr-FR");
            break;
          case 3:
            start("es-ES");
            break;
          case 4:
            start("pt-PT");
            break;
          case 5:
            start("nl-NL");
            break;
          case 6:
            start("pl-PL");
            break;
          case 7:
            start("id-ID");
            break;
          case 8:
            start("en-GB");
            break;
        }
      }
    });

    const commands = {
      saludos: ['saludos', 'hola', 'Buenas', 'Buenos días'],
      respuestasPreguntaArteFavorito: ['La monalisa'],
      respuestasOpinionRobot: ['a bueno', 'me alegra', 'si sabe'],
      modoReposo: ['reposo'],
      modoFrasesLentas: ['lento', 'cortas', 'lento'],
      modoFrasesNormales: ['normal', 'normales', 'normal'],
      modoFrasesLargas: ['largo', 'largas', 'rapido'],
      silenciar: ['silencio', 'callate'],
    }

    const arrsCommands = Object.values(commands)
    const arrAttachedCommands = [].concat(...arrsCommands);

    const arrAttachedCommandsLength = arrAttachedCommands.length

    const commandsLengths = []
    arrsCommands.forEach(elem => {
      commandsLengths.push(elem.length)
    })

    console.log('commandsLengths', commandsLengths)
    console.log(arrAttachedCommandsLength)

    const commandsLengthsLength = commandsLengths.length
    const arrSec = []
    let acumulador = [];

    for (let i = 0; i < commandsLengthsLength; i++) {
      if (i == 0) {
        arrSec.push(commandsLengths[i])
        acumulador.push(commandsLengths[i])
      } else {
        arrSec.push(acumulador.reduce((a, b) => a + b, 0) + commandsLengths[i])
        acumulador.push(commandsLengths[i])
      }
    }

    function identifySection(arrSecti, commandIndex) {
      let lastIndex = 0,
        defValue = 0;

      arrSecti.forEach((elem, index) => {

        if (commandIndex >= lastIndex && commandIndex < elem) {
          lastIndex = elem;
          defValue = index;
          return;
        }

        lastIndex = elem;
      })

      console.log(defValue, 'defValue')

      return defValue
    }

    // Sigue validacion con arrSec
    console.log(arrSec)

    let flag = false

    Jarvis.on(arrAttachedCommands).then(function(i) {

      console.log('variables:', arrSec, i)

      const defCommand = identifySection(arrSec, i)

      console.log('defCommand', defCommand)
      switch (defCommand) {
        case 0:
          Jarvis.dontObey();

          // console.log(Jarvis.getVoices());

          if (getRandomArbitrary(1, 2) == 1) {
            playVideo('saludoTrack');
          } else {
            // document.getElementById('saludoTrack').setAttribute('muted','true');
            // document.getElementById('saludoTrack').defaultMuted = true;
            // playVideo('saludoTrack');
            /**
             * Say something random of what is in the array when this function is triggered.
             */
            Jarvis.sayRandom([
              "Buenos días",
              "Ey, que bueno verte de nuevo",
              "Hola, ¿cómo vas?",
              "Que onda, ¿cómo estás?"
            ], {
              onStart() {
                Jarvis.dontObey();
              },
              onEnd() {
                Jarvis.obey();
              },
            });
          }
          Jarvis.obey();

          break;
        case 1:
          playVideo('respuestaTrack');
          break;
        case 2:
          playVideo('cierreTrack');
          break;
        case 3:
          playVideo('reposoTrack');
          Jarvis.say("Estoy sin hacer nada");
          break;
        case 4:
          Jarvis.say("Modo frases lentas activado", {
            onStart() {
              Jarvis.dontObey();
            },
            onEnd() {
              Jarvis.obey();
            },
          })
          start('es-ES', 'slow');
          if (respuestaMode) respuestaMode = 'slow'
          break;
        case 5:
          Jarvis.say("Modo frases normales activado", {
            onStart() {
              Jarvis.dontObey();
            },
            onEnd() {
              Jarvis.obey();
            },
          })
          start('es-ES', 'normal');
          if (respuestaMode) respuestaMode = 'normal'
          break;
        case 6:
          Jarvis.say("Modo frases rápidas activado", {
            onStart() {
              Jarvis.dontObey();
            },
            onEnd() {
              Jarvis.obey();
            },
          })
          start('es-ES', 'quick');
          if (respuestaMode) respuestaMode = 'quick'
          break;
        case 7:
          if(!flag){
            document.querySelectorAll('video').forEach(elem => {
  
              console.log(elem)
              // elem.setAttribute('muted', 'true')
              // elem.defaultMuted = true;
              elem.pause();
              // elem.currentTime = 0;
            });

            flag = true;
          }
          Jarvis.shutUp();

          break;
      }
    });

    // on command recognition end
    Jarvis.when("COMMAND_RECOGNITION_END", function(status) {
      if (status.code == "continuous_mode_enabled") {
        console.info("Command reconition finalized, restarting because the continuous mode is enabled");
      }
    });

    // Catch errors
    Jarvis.when("ERROR", function(data) {
      console.error(data);
    });


    start("es-ES", 'quick');
    // let UserDictation = Jarvis.newDictation({
    //   continuous: true, // Enable continuous if HTTPS connection
    //   onResult: function(text) {
    //     // Do something with the text
    //     console.log(text);
    //   },
    //   onStart: function() {
    //     console.log("Dictation started by the user");
    //   },
    //   onEnd: function() {
    //     alert("Dictation stopped by the user");
    //   }
    // });

    // UserDictation.start();
  </script>

</body>

</html>
<!-- HACER CLIC AL CARGAR LA PÁGINA POR PRIMERA VEZ -->